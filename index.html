<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="my-logo.png" type="image/png" />
  <title>Vinlotto</title>
  <style>
    :root {
      --wine: #7b1e26;
      --wine-dark: #5e141b;
      --bg: #faf9f7;
      --card: #fff;
      --border: #e2e2e2;
    }
    body {
      margin: 0;
      padding: 20px;
      background: var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: var(--wine-dark);
      display: flex;
      justify-content: center;
    }
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 32px;
      width: 100%;
      max-width: 600px;
      text-align: center;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      border: 1px solid var(--border);
    }
    h1 {
      font-size: 1.8rem;
      color: var(--wine-dark);
      margin-bottom: 0.2em;
    }
    p.sub {
      color: #666;
      margin-top: 0;
      margin-bottom: 1.1em;
    }
    #themeBox {
      margin: 20px auto;
      background: #fff5f6;
      border: 2px solid #e8d6d8;
      border-radius: 12px;
      padding: 18px;
      max-width: 420px;
      font-size: 1.1rem;
      color: var(--wine-dark);
      font-weight: 600;
      line-height: 1.6;
    }
    textarea {
      width: 100%;
      min-height: 200px;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 10px;
      font: inherit;
    }
    button {
      cursor: pointer;
      border: none;
      background: var(--wine);
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      transition: background 0.2s, transform 0.1s;
    }
    button:hover { background: var(--wine-dark); transform: scale(1.02); }
    button.secondary {
      background: #fff;
      color: var(--wine-dark);
      border: 1px solid var(--wine-dark);
    }
    .links { display: grid; gap: 12px; }
    .linkcard {
      background: #f9f8fa;
      border: 1px dashed #ccc;
      border-radius: 10px;
      padding: 14px;
    }
    .pill {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      background: #f3e8eb;
      border: 1px solid #e3c6cb;
      font-size: .8em;
      color: var(--wine-dark);
      font-weight: 600;
      margin-bottom: 4px;
    }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; word-break: break-all; }
    .muted { color: #666; font-size: .9em; }
    .actions { text-align: center; margin: 16px 0; }
    .visited { list-style: none; padding: 0; margin: 6px 0 14px; }
    .visited li { margin: 2px 0; }
    .tabs { display: flex; gap: 8px; position: absolute; left: 18px; top: 18px; }
    .tab {
      border: 1px solid var(--wine-dark);
      background: #fff;
      color: var(--wine-dark);
      border-radius: 10px;
      padding: 8px 12px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .tab.active { background: var(--wine); color: #fff; }
    .uploads { text-align: left; margin-top: 12px; }
    .count { text-align: right; color: #666; font-size: .9em; margin-top: 4px; }
    .pres-list {
      list-style: none;
      padding: 0;
      margin: 12px 0 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .pres-list li { line-height: 1.5; display: block; }
    .pres-meta { display: block; color: #666; font-size: .9em; font-weight: 700; }
    .pres-link { display: block; margin-top: 4px; }
    @media (max-width: 600px) {
      .card { padding: 20px; }
      h1 { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <div class="tabs">
    <button class="tab active" id="tab-lotto">Vinlotto</button>
    <button class="tab" id="tab-pres">Presentationer</button>
  </div>
  <div class="card" id="revealCard" style="display:none">
    <h1>🍇 Ditt vinområde</h1>
    <p class="sub">Den här sidan visar bara ditt eget område.</p>
    <div id="themeBox"></div>
  </div>

  <div class="card" id="adminCard">
    <h1>Vinlotto</h1>
    <p class="sub">24 vinregioner från start där en region slumpas till Simon, Isak och William per omgång. Var och en får sin egen hemliga länk.</p>
    <p class="sub">Redan besökta vinregioner:</p>
    <ul class="visited">
      <li>Piemonte (Italien)</li>
      <li>Stellenbosch (Sydafrika)</li>
      <li>Sonoma County (USA)</li>
    </ul>

    <textarea id="themesInput" spellcheck="false"></textarea>
    <div class="count" id="themeCount"></div>

    <div class="actions">
      <button id="genBtn">🎲 Skapa tre hemliga länkar</button>
    </div>

    <div id="linksBox" class="links">
      <div class="muted" style="text-align:center;">Inga länkar ännu.</div>
    </div>
  </div>

  <div class="card" id="presentationsCard" style="display:none">
    <h1>Presentationer 🍇</h1>
    <p class="sub">PDF-presentationer för redan besökta vinregioner.</p>
    <h3 style="margin-top:18px;">Presentationer (arkiv)</h3>
    <ul class="pres-list" id="storedPresList">
      <li class="muted">Inga sparade presentationer ännu.</li>
    </ul>
  </div>

<script>
(async function() {
  const qs = s => document.querySelector(s);
  const themesInput = qs('#themesInput');
  const genBtn = qs('#genBtn');
  const linksBox = qs('#linksBox');
  const revealCard = qs('#revealCard');
  const adminCard = qs('#adminCard');
  const themeBox = qs('#themeBox');
  const themeCount = qs('#themeCount');
  const tabLotto = qs('#tab-lotto');
  const tabPres = qs('#tab-pres');
  const presentationsCard = qs('#presentationsCard');
  const storedPresList = qs('#storedPresList');

  const personNames = ["Simon", "Isak", "William"];
  const defaultThemes = [
    "Barossa Valley, Australien", "Rioja, Spanien", "Mendoza, Argentina",
    "Bourgogne, Frankrike", "Toscana, Italien",
    "Priorat, Spanien", "Loire-dalen, Frankrike", "Maipo Valley, Chile", "Douro, Portugal",
    "Napa Valley, USA", "Alsace, Frankrike", "Veneto, Italien", "Ribera del Duero, Spanien",
    "Rhône-dalen, Frankrike", "Marlborough, Nya Zeeland", "Bordeaux, Frankrike", "Barolo, Italien",
    "Sicilien, Italien", "Rías Baixas, Spanien", "Mosel, Tyskland", "Willamette Valley, USA"
  ];
  themesInput.value = defaultThemes.join('\n');
  updateCount();
  themesInput.addEventListener('input', updateCount);

  const storedPresentations = [
    {
      name: "Stellenbosch.pdf",
      url: "Stellenbosch.pdf",
      date: "2026-01-31",
      place: "Vällingby, Stockholm"
    },
    {
      name: "Piemonte.pdf",
      url: "Piemonte.pdf",
      date: "2026-01-31",
      place: "Vällingby, Stockholm"
    }
  ];
  renderStoredPresentations();

  function shuffle(arr) {
    const a = arr.slice();
    for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  function makeLink(name, theme) {
    const payload = btoa(unescape(encodeURIComponent(JSON.stringify({ name, theme }))));
    const base = window.location.origin + window.location.pathname;
    return base + '#data=' + payload;
  }

  genBtn.addEventListener('click', () => {
    const themes = themesInput.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    if (themes.length < personNames.length) {
      alert('Behöver minst ' + personNames.length + ' regioner.');
      return;
    }
    const shuffled = shuffle(themes);
    const offset = Math.floor(Math.random() * (themes.length - personNames.length + 1));
    const picked = shuffled.slice(offset, offset + personNames.length);
    linksBox.innerHTML = '';
    picked.forEach((theme, i) => {
      const name = personNames[i];
      const url = makeLink(name, theme);
      const div = document.createElement('div');
      div.className = 'linkcard';
      div.innerHTML = `
        <div><span class="pill">${name}</span></div>
        <div class="mono">${url}</div>
        <div style="margin-top:6px; display:flex; gap:8px; justify-content:center;">
          <button class="secondary" id="copy-${i}">Kopiera</button>
          <a href="${url}" target="_blank" rel="noopener"><button>Öppna</button></a>
        </div>`;
      linksBox.appendChild(div);
      div.querySelector(`#copy-${i}`).addEventListener('click', async () => {
        await navigator.clipboard.writeText(url);
        const btn = div.querySelector(`#copy-${i}`);
        btn.textContent = '✅ Kopierad!';
        btn.disabled = true;
        setTimeout(() => { btn.textContent = 'Kopiera'; btn.disabled = false; }, 1500);
      });
    });
  });

  const hash = location.hash.match(/^#data=(.+)$/);
  if (hash) {
    try {
      const decoded = JSON.parse(decodeURIComponent(escape(atob(hash[1]))));
      adminCard.style.display = 'none';
      revealCard.style.display = '';
      themeBox.innerHTML = `
        <p>Tja <b>${decoded.name}</b> 🍷</p>
        <p>Din region du ska fördjupa dig inom är <b>${decoded.theme}</b>.</p>
        <p>Ska bli riktigt spännande att lära sig nya grejer!</p>
      `;
    } catch(e) {
      console.error(e);
    }
  }

  function showTab(tab) {
    const lotto = tab === 'lotto';
    adminCard.style.display = lotto ? '' : 'none';
    presentationsCard.style.display = lotto ? 'none' : '';
    tabLotto.classList.toggle('active', lotto);
    tabPres.classList.toggle('active', !lotto);
  }
  tabLotto.addEventListener('click', () => showTab('lotto'));
  tabPres.addEventListener('click', () => showTab('pres'));

  function updateCount() {
    const themes = themesInput.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
    themeCount.textContent = `Antal regioner: ${themes.length}`;
  }

  function renderStoredPresentations() {
    storedPresList.innerHTML = '';
    if (!storedPresentations.length) {
      storedPresList.innerHTML = '<li class="muted">Inga sparade presentationer ännu.</li>';
      return;
    }
    storedPresentations
      .slice()
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .forEach(p => {
        const li = document.createElement('li');
        li.innerHTML = `
          <span class="pres-meta">${p.date} – ${p.place}</span>
          <a class="pres-link" href="${p.url}" target="_blank" rel="noopener">${p.name}</a>
        `;
        storedPresList.appendChild(li);
      });
  }
})();
</script>
</body>
</html>
